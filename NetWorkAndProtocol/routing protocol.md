# 路由协议
<p align="right">2018.4.1 by iNARI

---
## 1.路由表概述
**路由器** 是用于网络层进行IP数据包传递的设备，它需要根据IP包中的目的地址选择一条合适的路径将数据包传递到目的主机。因此需要每一个路由器都维护一张路由表，这张路由表记录了目的主机的主机地址或是网络地址。

#### 1.1 路由表内容
路由表通常包含`Destination`, `GateWay`, `Mask`, `Flag`, `Interface`等几项。
其中`Destination`和Mask或者Flag确定目的地址（一个主机地址或者是网络地址，根据Mask和Flag不同而不同）。
对于一个给定的路由器，可以打印出5中不同的`Flag`：
* U 该路由可以使用。
* G 该路由是一个 **网关（或者路由器）** 。如果没有该标志，表示本路由器是与目标直接相连的。 *（可以区分直接路由与间接路由，而这个路由的目的地址可能为网络地址也可能为主机地址）*
* H 表示该路由是到一个 **主机** 的路由，destination是一个主机地址，如果没有该标志说明该路由是一条到网络地址的路由，destination是一个网络地址。
* D 该路由是由重定向报文创建的。
* M 该路由已经重定向报文修改。

而`GateWay`给出的是下一站的地址，就是外出地址，这项通常与Interface两项共同确定跳到下一个路由器的链路,Interface和GateWay是同一网段的。当该项路由记录是发往一个直接路由的时候，GateWay和Interface应该是同一个地址

`Interface`是本地接口的名称，指明本条路由由本机的哪一个接口发出。

如果路由表中没有匹配的项（也没有缺省路由）的时候，就会向应用或者转发的主机发送一份 **ICMP主机不可达差错报文**。

#### 1.2 路由表的搜索顺序
如果一个路由器接受到一个IP报文，它会进行如下几部操作：
1. 搜索匹配的主机地址；
2. 搜索匹配的网络地址；
3. 搜索默认表项（默认路由一般被指定为一个网络表项，其网络号为0）

对于主机的匹配始终发生在匹配而网络地址步骤之前。

#### 1.3 ICMP重定向报文
ICMP重定向报文是当主机采用非最优路由发送数据报时，路由器会发回ICMP重定向报文来通知主机最优路由的存在。并且重定向报文**必须由路由器**生成，当主机作为路由器使用时，必须将其内核配置成可以发送重定向报文。重定向报文是为**主机**而不是路由器服务的。
假如一个主机所在的子网上有两个的路由器R1和R2，主机发送的数据包，由于主机的默认路由是R1，所以将该数据报发送给R1，但是R1发现这个数据报的下一站是R2，这时，R1会向主机发送一个ICMP重定向报文，告诉主机以后把数据报发送给R2，允许主机更新路由表，并且将主机数据包转发到R2。
重定向报文一般用来让具有很少选路信息的主机主键建立更加完善的路由表.重定向报文个数如下图所示:
![](images/routing_protocol/1-1.png)

更多关于ICMP重定向的内容[参见本文](http://blog.51cto.com/82880/68795)。

#### 1.4 ICMP路由发现报文
主机在引导之后要发送一份路由器请求报文，一台或多台路由器相应该报文，可以由此配置默认路由。但同时，路由器应该定时广播其路由器通告报文，允许每个监听的主机相应的更新他们的路由表。
路由器请求报文格式如下图所示：
![](images/routing_protocol/1-2.jpg)
路由器通告报文的格式如下图所示：
![](images/routing_protocol/1-3.jpg)

---

# 2 动态路由协议
