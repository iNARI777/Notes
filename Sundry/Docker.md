# Docker 基本知识笔记

## 1. Docker 的基本要素

Docker 有三大基本要素：镜像（Image）/容器（Container）/仓库（Registry）。

### 1.1 Docker 镜像

Docker 的镜像就相当于一个 `root` 文件系统，除了提供容器运行的时候提供所需的程序/库/资源和配置文件外，还包含了一些为运行时准备的配置参数（如匿名卷/环境变量和用户等）。镜像内不包含任何动态数据，其内容在镜像被构建之后就不会被改变。

**分层存储**

Docker 在构建的时候，前一层的存储是后一层的基础，任何一层上的改变只会影响到这一层，而不会影响到上一层。

### 1.2 Docker 容器

容器和镜像的关系就像是 Java 中对象和类的关系。

容器的本质是一个进程，但它与直接运行在宿主的进程不同，每个镜像都运行在各自独立的[命名空间](https://en.wikipedia.org/wiki/Linux_namespaces)中，这一点为容器提供了良好的隔离性。

容器存储层的生命周期与容器的生命周期是相同的，容器销毁的同时，容器的存储层也会被销毁。任何保存在容器存储层的信息也都不会保留。

### 1.3 Registry 仓库

略过。

## 2. 镜像的使用

### 2.1 获取镜像

官方的 Docker Hub 上有大量的高质量官方镜像可以使用，所用到的命令：

    docker pull [选项] [仓库地址：端口号] 仓库名：标签

> 这里的仓库名通常是由两端构成： <用户名>/软件名，对于 Docker Hub 来说，如果用户名不填的话就是默认的 libaray 用户，也就是官方镜像。而标签的默认值是 `latest`。

比如说我想下载一个 Ubuntu 的镜像，就可以使用：

    docker pull ubuntu:16.04

在下载的过程中，我们可以看到会有好几个 `pull complete` 的提示出现，这就是我们之前说到的分层存储的体现，根据依赖的镜像层层构建，并会显示出每一层镜像的 ID 和 sha256 的值。这两个值是会改变的，因为镜像一直在维护。

### 2.2 基本操作

**运行**

使用 `docker run [选项] 镜像名` 命令运行。

在运行的时候可以通过 `--name` 选项来制定运行的容器的名称，`-p <外部端口>:<docker 端口>` 参数可以用来进行端口映射。

**查看镜像**

使用 `docker images ls [镜像名:<标签>]` 可以列出所有[/部分]已经下载下来的镜像，可以看到 `仓库名`/`标签`/`镜像 ID`/`创建时间`以及`占用空间`。

这种方式只能看到顶层的镜像，但是中间镜像是无法看到的。如果想看中间层的镜像，可以加一个 `-a` 选项。

其中，镜像 ID 是一个镜像的唯一标识。

而镜像体积比我们在 Docker Hub 上看到的要大，因为 Docker Hub 上显示的是压缩过后的体积。但是本地显示的是解压之后的体积。要注意，本地看到的镜像体积的总和不一定是所有镜像的体积加起来，因为分层存储的存在，很多镜像是可以复用的，因此实际体积会小很多。

想查看所有镜像的实际体积可以使用一下指令：

    docker system df

**虚悬镜像**

有时候我们可以看到镜像列表中有的镜像光有体积，但是没有镜像名等信息，这种情况是由于前后两次 `docker pull` 相同版本的相同镜像，而随着官方的维护，旧的镜像已经被废除，从而导致镜像名转移到了新 pull 下来的镜像上，而以前的镜像就变成了没有存在价值的 **虚悬镜像** 。可以使用一下指令查看这种镜像：

    docker images ls -f dangling=true

对于这种镜像，可以使用 `docker image prune` 来删除。

**删除镜像**

可以使用如下指令删除镜像：

    docker images rm <镜像>

这里的镜像有很多种表示方式：镜像名/镜像 ID/镜像摘要。

可以通过 `docker images ls --digests` 来看到镜像的摘要。

> 有一点需要注意，使用了 rm 指令之后，相应的镜像不一定会在物理层面被删除，可能只是删除了指向这个镜像的一个标签，但是还有可能有其他标签指向这个镜像，或是有上层的镜像依赖于这个镜像。只有当这个镜像已经没有标签，且没有上层镜像依赖于这个镜像，且这个镜像没有相应的容器在运行的时候，这个镜像才会被真正删除。

同时可以使用 ls 指令配合 -p 参数实现删除：

    docker images rm $(docker images ls -q redis)
    docker images rm $(docker images ls -q -f before=mongo:3.2)
